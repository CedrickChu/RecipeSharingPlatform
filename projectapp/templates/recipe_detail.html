{% extends 'base.html' %}
{% block navbar %}
    {% include 'header.html' %}
{% endblock %}
{% block title %}
    Recipe Detail
{% endblock %}



{% block content %}
<section>
    <h1 class='recipe-title'>{{ recipe.title }}</h1>
    <h3>{{ recipe.description }}</h3>
    {% if recipe.image %}
        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
    {% endif %}
    <p style='font-size: 30px; font-weight:bold'>Ingredients</p>
    <p style='font-size: 20px;'>{{ recipe.ingredients }}</p>
    <p style='font-size: 30px; font-weight:bold'>Instructions</p>
    <p style='font-size: 20px;'>{{ recipe.instructions }}</p>
    
    <p style='font-size: 20px;'><strong>Created by:</strong> {{ recipe.created_by.username }}</p>
   <p style='font-size: 20px;'><strong>Created at:</strong> {{ recipe.created_at }}</p>
    <form id="ratingForm">
        {% csrf_token %}
        <div class='rating'>
            <span onclick="updateRating(1)" class="star">★</span>
            <span onclick="updateRating(2)" class="star">★</span>
            <span onclick="updateRating(3)" class="star">★</span>
            <span onclick="updateRating(4)" class="star">★</span>
            <span onclick="updateRating(5)" class="star">★</span>
            <h3 id="outputText">Rating is: 0/5</h3>
        </div>
    </form>
    <script>
        let recipeId = {{ recipe.id }};
    
        function updateRating(value) {
            console.log('updateRating called with value:', value);
        
            // Attempt to parse the value as an integer
            const intValue = parseInt(value);
        
            // Log the type and parsed integer value
            console.log('Type of intValue:', typeof intValue);
            console.log('Parsed integer:', intValue);
        
            // Validate that intValue is a valid integer
            if (!Number.isInteger(intValue) || intValue < 1 || intValue > 5) {
                console.error('Invalid rating value');
                return;
            }
        
            const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
            console.log('CSRF Token:', csrfToken);
        
            // Log the fetch request body
            const requestBody = JSON.stringify({ rating_value: intValue });
            console.log('Fetch request body:', requestBody);
        
            fetch(`/recipe/${recipeId}/rate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: requestBody,
            })
            .then(response => response.json())
            .then(data => {
                console.log('Fetch completed.');
        
                if (data.success) {
                    // Update the frontend display, e.g., update the stars or display the average rating.
                    const outputText = document.getElementById('outputText');
                    outputText.innerHTML = `Rating is: ${data.average_rating}/5`;
                } else {
                    // Handle errors if needed.
                    console.error('Error:', data.error_message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
   <div class="recipe">
        {% if recipe.average_rating %}
            <p id="average-rating">Average Rating: {{ recipe.average_rating|floatformat:1 }} / 5 </p>
        {% else %}
            <p id="average-rating">No ratings yet.</p>
        {% endif %}

        {% for comment in recipe.comments.all %}
            <p>
                {{ comment.user.username }}: {{ comment.text }}
                {% if comment.user == request.user %}
                <div class="kebab-dropdown">
                    <div class="kebab-icon" onclick="toggleDropdown()">&#8942;</div>
                    <div class="dropdown-content" id="myDropdown">
                      <a href="#" onclick="editOption()">Edit</a>
                      <a href="#" onclick="deleteOption()">Delete</a>
                    </div>
                  </div>
                {% comment %} <button class="edit-comment" data-comment-id="{{ comment.id }}">Edit</button>
                <button class="delete-comment" data-comment-id="{{ comment.id }}" data-user-id="{{ comment.user.id }}">Delete</button> {% endcomment %}
                {% endif %}
            </p>
        {% endfor %}

        <form method="post" action="{% url 'add_comment' recipe.id %}" class="comment-form">
            {% csrf_token %}
            <div class="form-group">
                <textarea class="form-control" for='text' name="text" placeholder="Write a comment..."></textarea>
            </div>
            <button type="submit">Submit Comment</button>
        </form>
    </div>
    </section>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.delete-comment').forEach(function (button) {
        button.addEventListener('click', function () {
            var commentId = this.getAttribute('data-comment-id');
            var commentUserId = this.getAttribute('data-user-id');

            deleteComment(commentId, commentUserId);
        });
    });

    // Attach click event listeners to all edit buttons
    document.querySelectorAll('.edit-comment-button').forEach(function (button) {
        button.addEventListener('click', function (event) {
            event.stopPropagation(); // Prevent click event from propagating to parent elements

            var commentId = this.getAttribute('data-comment-id');
            var commentTextElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            var currentText = commentTextElement.textContent;

            // Replace comment text with an input field
            var inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.value = currentText;
            commentTextElement.innerHTML = '';
            commentTextElement.appendChild(inputField);

            // Create a save button
            var saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.addEventListener('click', function () {
                var updatedText = inputField.value;

                // Check if the text has changed
                if (updatedText !== currentText) {
                    editComment(commentId, updatedText);
                } else {
                    // If text hasn't changed, revert back to displaying the text
                    commentTextElement.textContent = currentText;
                }
            });

            // Create a cancel button
            var cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', function () {
                // Revert back to displaying the original text
                commentTextElement.textContent = currentText;
            });

            commentTextElement.appendChild(saveButton);
            commentTextElement.appendChild(cancelButton);
        });
    });

    function deleteComment(commentId, commentUserId) {
        var loggedInUserId = '{{ request.user.id }}';

        if (commentUserId !== loggedInUserId) {
            alert('You do not have permission to delete this comment.');
            return;
        }

        // Add a confirmation dialog
        var confirmDelete = confirm("Are you sure you want to delete this comment?");
        if (!confirmDelete) {
            return; // Exit the function if the user did not confirm
        }

        console.log('Fetching...');

        fetch(`/delete_comment/${commentId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var commentElement = document.querySelector(`[data-comment-id="${commentId}"]`).closest('p');
                if (commentElement) {
                    commentElement.parentNode.removeChild(commentElement);
                }
            } else {
                console.error('Failed to delete comment:', data.error);
            }
        })
        .catch(error => {
            console.error('Error during delete comment request:', error);
        });
    }

    function editComment(commentId, commentText) {
        fetch(`/edit_comment/${commentId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'new_text': commentText,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                if (commentElement) {
                    commentElement.textContent = commentText;
                }
            } else {
                console.error('Failed to edit comment:', data.error);
            }
        })
        .catch(error => {
            console.error('Error during edit comment request:', error);
        });
    }
    });
</script>
{% endblock %}
